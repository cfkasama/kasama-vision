// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model Municipality {
  id        String  @id @default(cuid())
  createdAt DateTime @default(now())
  name      String
  slug      String  @unique        // 例: "kasama"
  prefecture String?               // 例: "茨城県"
  code      String?                // JIS コード等（任意）

// 集計カラム（累計）
  liveCount     Int   @default(0)
  workCount     Int   @default(0)
  tourismCount  Int   @default(0)

  posts     Post[]
  intents   Intent[]

  @@index([slug])
}

model Identity {
  id           String        @id @default(cuid())
  createdAt    DateTime      @default(now())
lockedUntil DateTime?
lockedReason String?
  reactions    Reaction[]
  comments     Comment[]
  abuseReports AbuseReport[]
  commentActions CommentAction[]
posts        Post[]
intents        Intent[]
}

model Post {
  id               String      @id @default(cuid())
  type             PostType
  status           PostStatus  @default(PUBLISHED)
  title            String
  content          String?     @db.Text
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  likeCount        Int         @default(0)
  recCount         Int         @default(0)
  cmtCount         Int         @default(0)
  hotScore         Float       @default(0)

  deleteKey        String?
  lowExposureActive Boolean    @default(false)
  lowExposureAt    DateTime?
  tempHiddenActive Boolean     @default(false)
  tempHiddenAt     DateTime?
  realizedAt       DateTime?

  identityId  String?
  identity  Identity? @relation(fields:[identityId],references:[id], onDelete: SetNull)

// ★ 追加
  municipalityId String
  municipality   Municipality  @relation(fields: [municipalityId], references: [id], onDelete: Restrict)

  reactions        Reaction[]
  comments         Comment[]
  tags             PostTag[]
abuseReports     AbuseReport[]
adminLogs AdminLog[]
  @@index([municipalityId])
}

model Reaction {
  id         String       @id @default(cuid())
  type       ReactionType
  createdAt  DateTime     @default(now())

  postId     String
  post       Post         @relation(fields: [postId], references: [id])

  identityId String?
  identity   Identity?    @relation(fields: [identityId], references: [id])

  @@unique([postId, identityId, type])
}

enum CommentKind{
COMMENT
CHALLENGE
ACHIEVEMENT
}

model Comment {
  id         String     @id @default(cuid())
  content    String     @db.Text
  likeCount  Int        @default(0)
  recCount  Int        @default(0)
  createdAt  DateTime   @default(now())
  deleteKey  String?
  deletedAt   DateTime?
  kind  CommentKind @default(COMMENT)

  postId     String
  post       Post       @relation(fields: [postId], references: [id])

  identityId String?
  identity   Identity?  @relation(fields: [identityId], references: [id])
  actions CommentAction[]
abuseReports     AbuseReport[]
}

model AbuseReport {
  id         String       @id @default(cuid())
  reason     String?
  status     ReportStatus @default(OPEN)
  createdAt  DateTime     @default(now())
  resolvedAt DateTime?
  resolver   String?
  note       String?

  postId     String
  post       Post         @relation(fields: [postId], references: [id], onDelete: Cascade)

  commentId String?
  comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  identityId String?
  identity   Identity?    @relation(fields: [identityId], references: [id])
}

model Tag {
  id    String    @id @default(cuid())
  name  String    @unique
  posts PostTag[]
}

model PostTag {
  postId String
  tagId  String

  post   Post @relation(fields: [postId], references: [id])
  tag    Tag  @relation(fields: [tagId], references: [id])

  @@id([postId, tagId])
}

model TagTop5 {
  id        String   @id @default(cuid())
  tagId     String
  tagName   String
  count     Int      @default(0)
  updatedAt DateTime @default(now())
}

model AdminLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  actor     String                    // 例: 管理者メール/GitHubアカウント
  action    String                    // 例: "REMOVE_POST" / "DISMISS" など
  target    String?                   // 例: "post:abc123" や "report:xyz"
  note      String?
  meta      Json?                     // 任意の追加情報（diffなど）
postId      String?
post      Post? @relation(fields:[postId],references:[id],onDelete:SetNull)

  @@index([createdAt])
  @@index([actor])
  @@index([action])
}

enum PostType {
  CATCHPHRASE
  VISION
  CONSULTATION
  PROPOSAL
  REPORT_LIVE
  REPORT_WORK
  REPORT_TOURISM
}

enum PostStatus {
  PUBLISHED
  REMOVED
  CHALLENGE
  REALIZED
}

enum ReactionType {
  LIKE
  RECOMMEND
}

enum ReportStatus {
  OPEN
  RESOLVED
  DISMISSED
}

enum CommentActionType {
  LIKE
  RECOMMEND
}

model CommentAction {
  commentId  String
  identityId String
  type       CommentActionType
  createdAt  DateTime @default(now())

  comment    Comment   @relation(fields: [commentId], references: [id], onDelete: Cascade)
  identity   Identity  @relation(fields: [identityId], references: [id], onDelete: Cascade)

  @@id([commentId, identityId, type])

  @@index([commentId, createdAt])
  @@index([identityId, createdAt])
}

enum IntentKind {
  LIVE
  WORK
  TOURISM
}
// prisma/schema.prisma の Intent を置き換え
model Intent {
  id              String   @id @default(uuid())
  identityId      String
  municipalityId  String   // ★ 追加
  kind            IntentKind
  createdAt       DateTime @default(now())

  identity     Identity      @relation(fields: [identityId], references: [id], onDelete: Cascade)
  municipality Municipality  @relation(fields: [municipalityId], references: [id], onDelete: Cascade)
  @@index([municipalityId, kind])
  @@unique([identityId, municipalityId, kind]) 
}
